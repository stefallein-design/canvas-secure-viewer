<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Secure Viewer</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; }

      /* Progress bar */
      #progressWrap {
        position: sticky;
        top: 0;
        z-index: 20;
        height: 4px;
        background: rgba(0,0,0,0.06);
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background: rgba(0,0,0,0.55);
        transition: width 80ms linear;
      }

      /* Topbar */
      #bar {
        position: sticky;
        top: 4px; /* under progress */
        z-index: 15;
        background: rgba(255,255,255,0.96);
        border-bottom: 1px solid #eee;
        padding: 10px 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      #bar button {
        padding: 6px 10px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 10px;
        cursor: pointer;
      }
      #bar button:active { transform: translateY(1px); }
      #bar button.active {
        border-color: #999;
        background: #f3f3f3;
        font-weight: 600;
      }

      #bar input[type="range"] { width: 170px; }

      /* Labels */
      #zoomLabel { min-width: 64px; text-align: right; color: #333; font-size: 14px; }
      #pageIndicator { color: #333; font-size: 14px; padding-left: 2px; }
      #studyTime { color:#333; font-size: 14px; padding-left: 2px; white-space: nowrap; }

      /* Auto badge */
      #autoBadge {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: #f7f7f7;
        border-radius: 999px;
        font-size: 13px;
        color: #333;
        white-space: nowrap;
      }

      #msg { padding: 10px 12px; color: #b00020; font-size: 14px; }

      /* Layout */
      #pagesWrap { display: grid; justify-items: center; }

      #pages {
        width: min(1100px, 100%);
        padding: 16px;
        display: grid;
        gap: 16px;
      }

      /* Zoom transform on this layer */
      #scaleLayer {
        transform: scale(var(--zoom, 1));
        transform-origin: top center;
        will-change: transform;
      }

      /* Page card */
      .pageCard {
        position: relative;
        background: #fff;
      }

      /* Page toolbar (bookmark/important) */
      .pageTools {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
        z-index: 5;
      }
      .toolBtn {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,0.18);
        background: rgba(255,255,255,0.92);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 18px;
        line-height: 1;
      }
      .toolBtn:active { transform: translateY(1px); }
      .toolBtn.on {
        background: rgba(0,0,0,0.08);
        border-color: rgba(0,0,0,0.35);
      }

      img { width: 100%; height: auto; border: 1px solid #eee; display: block; }

      /* Geen tekstselectie / slepen */
      body { -webkit-user-select: none; user-select: none; }
      img { -webkit-user-drag: none; user-drag: none; }

      /* Pinch */
      #pinchArea { touch-action: pan-x pan-y; }

      /* Watermark overlay */
      #wm {
        position: fixed;
        inset: 0;
        z-index: 9999;
        pointer-events: none;
        opacity: 0.075;
        transform: rotate(-18deg);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: 180px;
        align-items: center;
        justify-items: center;
        text-align: center;
        font-size: 20px;
        line-height: 1.35;
        padding: 24px;
        gap: 10px;
      }
      .wm-cell { white-space: pre-wrap; padding: 8px 12px; }

      /* Bookmarks panel */
      #bmPanel {
        position: fixed;
        top: 8px;
        right: 8px;
        z-index: 30;
        width: min(360px, calc(100vw - 16px));
        max-height: calc(100vh - 16px);
        overflow: auto;
        background: rgba(255,255,255,0.98);
        border: 1px solid #e2e2e2;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        padding: 10px;
        display: none;
      }
      #bmPanel h3 {
        margin: 6px 6px 10px 6px;
        font-size: 16px;
      }
      .bmRow {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 10px;
      }
      .bmRow:hover { background: rgba(0,0,0,0.04); }
      .bmRow button {
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 10px;
        padding: 6px 10px;
        cursor: pointer;
      }
      .bmMeta { flex: 1; font-size: 14px; color: #333; }
      .bmTag { font-size: 12px; color: #666; }
      .bmDel { font-size: 12px; color: #b00020; border-color: #f0c6c6; }
      #bmClose { float: right; }

      /* Soft inactivity prompt */
      #idlePrompt {
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 12px;
        z-index: 40;
        display: none;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        background: rgba(255,255,255,0.98);
        border: 1px solid #e2e2e2;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        padding: 10px 12px;
        font-size: 14px;
        color: #333;
      }
      #idlePrompt button {
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 10px;
        padding: 6px 10px;
        cursor: pointer;
        white-space: nowrap;
      }

      /* Focus mode */
      body.focus #bar,
      body.focus #progressWrap,
      body.focus #bmPanel {
        display: none !important;
      }
      body.focus #pages {
        width: min(1400px, 100%);
        padding-top: 24px;
      }
      body.focus #msg { display: none; }
      body.focus {
        background: #111;
      }
      body.focus #pagesWrap {
        background: #111;
      }
      body.focus .pageCard {
        background: #111;
      }
      body.focus img {
        border-color: rgba(255,255,255,0.10);
      }
      /* In focus mode, keep page tools but make them subtle */
      body.focus .toolBtn {
        background: rgba(20,20,20,0.55);
        border-color: rgba(255,255,255,0.16);
        color: #fff;
      }
      body.focus .toolBtn.on {
        background: rgba(255,255,255,0.14);
      }
    </style>
  </head>

  <body>
    <div id="wm"></div>

    <div id="progressWrap"><div id="progressBar"></div></div>

    <div id="bar" aria-label="Study controls">
      <!-- NEW: vorige/volgende -->
      <button id="btnPrev" type="button" title="Vorige pagina">‚óÄ</button>
      <button id="btnNext" type="button" title="Volgende pagina">‚ñ∂</button>

      <button id="zoomOut" type="button">‚àí</button>
      <input id="zoom" type="range" min="50" max="200" value="100" />
      <button id="zoomIn" type="button">+</button>

      <button id="zoomReset" type="button">100%</button>
      <button id="zoomFit" type="button">Passend</button>

      <button id="modeWidth" type="button">Breedte</button>
      <button id="modePage" type="button">Pagina</button>

      <div id="zoomLabel">100%</div>

      <div id="autoBadge" title="Deze modus blijft automatisch volgen bij resize/rotatie">
        <span>Auto</span><span aria-hidden="true">üîí</span><span id="autoText"></span>
      </div>

      <div id="pageIndicator"></div>

      <!-- NEW: studietijd -->
      <div id="studyTime"></div>

      <button id="btnBookmarks" type="button" title="Bladwijzers & belangrijk">‚≠ê</button>
      <button id="btnFocus" type="button" title="Focus-modus (ESC om te sluiten)">Focus</button>
    </div>

    <div id="bmPanel" role="dialog" aria-label="Bladwijzers">
      <button id="bmClose">Sluiten</button>
      <h3>Bladwijzers & belangrijk</h3>
      <div id="bmList"></div>
      <div style="padding: 8px; font-size: 12px; color:#666;">
        Dit is persoonlijk (alleen op jouw toestel/browser).
      </div>
    </div>

    <!-- NEW: inactivity prompt -->
    <div id="idlePrompt">
      <div>Nog aan het studeren?</div>
      <div style="display:flex; gap:8px;">
        <button id="idleYes">Ja, verder</button>
        <button id="idleHide">Sluiten</button>
      </div>
    </div>

    <div id="msg"></div>

    <div id="pagesWrap">
      <div id="pinchArea">
        <div id="scaleLayer">
          <div id="pages"></div>
        </div>
      </div>
    </div>

    <script>
      // Rechtermuisklik blokkeren
      document.addEventListener("contextmenu", (e) => e.preventDefault());

      // Ctrl/Cmd+S en Ctrl/Cmd+P blokkeren
      document.addEventListener("keydown", (e) => {
        const key = (e.key || "").toLowerCase();
        if ((e.ctrlKey || e.metaKey) && (key === "s" || key === "p")) e.preventDefault();
      });

      // Helpers
      function makeTiledWatermark(text) {
        const wmEl = document.getElementById("wm");
        wmEl.innerHTML = "";
        const cells = 18;
        for (let i = 0; i < cells; i++) {
          const cell = document.createElement("div");
          cell.className = "wm-cell";
          cell.textContent = text;
          wmEl.appendChild(cell);
        }
      }

      function safeJsonParse(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function formatMMSS(seconds) {
        const s = Math.max(0, Math.floor(seconds));
        const mm = String(Math.floor(s / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${mm}:${ss}`;
      }

      // Elements
      const pagesEl = document.getElementById("pages");
      const pinchArea = document.getElementById("pinchArea");
      const scaleLayer = document.getElementById("scaleLayer");

      const zoomEl = document.getElementById("zoom");
      const zoomLabel = document.getElementById("zoomLabel");

      const zoomOutBtn = document.getElementById("zoomOut");
      const zoomInBtn = document.getElementById("zoomIn");
      const zoomResetBtn = document.getElementById("zoomReset");
      const zoomFitBtn = document.getElementById("zoomFit");

      const modeWidthBtn = document.getElementById("modeWidth");
      const modePageBtn = document.getElementById("modePage");

      const autoBadge = document.getElementById("autoBadge");
      const autoText = document.getElementById("autoText");

      const pageIndicator = document.getElementById("pageIndicator");
      const progressBar = document.getElementById("progressBar");

      const btnBookmarks = document.getElementById("btnBookmarks");
      const bmPanel = document.getElementById("bmPanel");
      const bmClose = document.getElementById("bmClose");
      const bmList = document.getElementById("bmList");

      const btnFocus = document.getElementById("btnFocus");

      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");

      const studyTimeEl = document.getElementById("studyTime");

      const idlePrompt = document.getElementById("idlePrompt");
      const idleYes = document.getElementById("idleYes");
      const idleHide = document.getElementById("idleHide");

      const msg = document.getElementById("msg");

      // State
      let zoomPct = 100;
      let followMode = "none"; // none | width | page

      let docId = "";
      let pageList = [];
      let pageIndexByNumber = new Map(); // original pageNum -> index in list
      let currentVisiblePage = null;

      // ----- Marks storage
      function storageKey() { return `sv_marks_${docId}`; }

      function loadMarks() {
        const raw = localStorage.getItem(storageKey()) || "";
        const obj = safeJsonParse(raw, { bookmarks: {}, important: {} });
        if (!obj.bookmarks) obj.bookmarks = {};
        if (!obj.important) obj.important = {};
        return obj;
      }
      function saveMarks(obj) { localStorage.setItem(storageKey(), JSON.stringify(obj)); }

      function toggleMark(type, pageNum) {
        const marks = loadMarks();
        const bag = (type === "bookmark") ? marks.bookmarks : marks.important;
        if (bag[String(pageNum)]) delete bag[String(pageNum)];
        else bag[String(pageNum)] = true;
        saveMarks(marks);
        renderBookmarksPanel();
        updatePageToolButtons(pageNum);
      }

      function isMarked(type, pageNum) {
        const marks = loadMarks();
        const bag = (type === "bookmark") ? marks.bookmarks : marks.important;
        return !!bag[String(pageNum)];
      }

      function updatePageToolButtons(pageNum) {
        const card = document.querySelector(`.pageCard[data-page="${pageNum}"]`);
        if (!card) return;
        const bmBtn = card.querySelector(`[data-action="bookmark"]`);
        const impBtn = card.querySelector(`[data-action="important"]`);
        if (bmBtn) bmBtn.classList.toggle("on", isMarked("bookmark", pageNum));
        if (impBtn) impBtn.classList.toggle("on", isMarked("important", pageNum));
      }

      function scrollToPage(pageNum) {
        const el = document.querySelector(`.pageCard[data-page="${pageNum}"]`);
        if (!el) return;
        el.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      // NEW: auto herhaallijst = bookmarks + important samen (zonder duplicaten)
      function getRepeatList() {
        const marks = loadMarks();
        const allowed = new Set(pageList);

        const bm = Object.keys(marks.bookmarks || {}).map(n => parseInt(n,10)).filter(Boolean).filter(n => allowed.has(n));
        const imp = Object.keys(marks.important || {}).map(n => parseInt(n,10)).filter(Boolean).filter(n => allowed.has(n));

        const all = Array.from(new Set([...imp, ...bm])); // important eerst, maar set maakt uniek
        all.sort((a,b) => a - b);
        return { imp, bm, all };
      }

      function renderBookmarksPanel() {
        if (!docId) return;

        const { imp, bm, all } = getRepeatList();

        const rows = [];

        // NEW: Herhaal nu
        rows.push(`<div style="padding:6px 8px; font-weight:700; color:#333;">Herhaal nu</div>`);
        if (all.length) {
          for (const n of all) {
            const tags = [];
            if (imp.includes(n)) tags.push("‚≠ê");
            if (bm.includes(n)) tags.push("üîñ");
            rows.push(`
              <div class="bmRow">
                <div class="bmMeta">Pagina ${n}</div>
                <div class="bmTag">${tags.join(" ")}</div>
                <button onclick="window.__sv.goto(${n})">Ga</button>
              </div>
            `);
          }
        } else {
          rows.push(`<div style="padding:6px 8px; color:#666;">Nog geen ‚≠ê of üîñ om te herhalen.</div>`);
        }

        rows.push(`<div style="height:12px;"></div>`);

        // Bladwijzers
        rows.push(`<div style="padding:6px 8px; font-weight:600; color:#333;">Bladwijzers</div>`);
        const bmSorted = [...bm].sort((a,b)=>a-b);
        if (bmSorted.length) {
          for (const n of bmSorted) {
            rows.push(`
              <div class="bmRow">
                <div class="bmMeta">Pagina ${n}</div>
                <div class="bmTag">üîñ</div>
                <button onclick="window.__sv.goto(${n})">Ga</button>
                <button class="bmDel" onclick="window.__sv.unmark('bookmark', ${n})">Verwijder</button>
              </div>
            `);
          }
        } else {
          rows.push(`<div style="padding:6px 8px; color:#666;">Geen bladwijzers.</div>`);
        }

        rows.push(`<div style="height:10px;"></div>`);

        // Belangrijk
        rows.push(`<div style="padding:6px 8px; font-weight:600; color:#333;">Belangrijk</div>`);
        const impSorted = [...imp].sort((a,b)=>a-b);
        if (impSorted.length) {
          for (const n of impSorted) {
            rows.push(`
              <div class="bmRow">
                <div class="bmMeta">Pagina ${n}</div>
                <div class="bmTag">‚≠ê</div>
                <button onclick="window.__sv.goto(${n})">Ga</button>
                <button class="bmDel" onclick="window.__sv.unmark('important', ${n})">Verwijder</button>
              </div>
            `);
          }
        } else {
          rows.push(`<div style="padding:6px 8px; color:#666;">Nog niets als belangrijk gemarkeerd.</div>`);
        }

        bmList.innerHTML = rows.join("");
      }

      window.__sv = {
        goto: (n) => scrollToPage(n),
        unmark: (type, n) => {
          const marks = loadMarks();
          const bag = (type === "bookmark") ? marks.bookmarks : marks.important;
          delete bag[String(n)];
          saveMarks(marks);
          renderBookmarksPanel();
          updatePageToolButtons(n);
        }
      };

      // --- Zoom / modes
      function updateAutoBadge() {
        if (followMode === "width") {
          autoText.textContent = "Breedte";
          autoBadge.style.display = "inline-flex";
        } else if (followMode === "page") {
          autoText.textContent = "Pagina";
          autoBadge.style.display = "inline-flex";
        } else {
          autoBadge.style.display = "none";
          autoText.textContent = "";
        }
      }

      function setActiveModeButtons() {
        modeWidthBtn.classList.toggle("active", followMode === "width");
        modePageBtn.classList.toggle("active", followMode === "page");
        updateAutoBadge();
      }

      function applyZoom() {
        const clamped = clamp(zoomPct, 50, 200);
        zoomPct = clamped;
        zoomEl.value = String(clamped);
        zoomLabel.textContent = `${clamped}%`;
        scaleLayer.style.setProperty("--zoom", String(clamped / 100));
        try { localStorage.setItem("sv_zoom", String(clamped)); } catch (_) {}
      }

      function setZoomPercent(pct) { zoomPct = pct; applyZoom(); }

      function setFollowMode(mode) {
        followMode = mode;
        setActiveModeButtons();
        try { localStorage.setItem("sv_follow_mode", followMode); } catch (_) {}
      }

      function disableFollowMode() {
        if (followMode !== "none") setFollowMode("none");
      }

      // Load saved zoom + mode
      try {
        const savedZoom = parseInt(localStorage.getItem("sv_zoom") || "100", 10);
        zoomPct = Number.isFinite(savedZoom) ? savedZoom : 100;
      } catch (_) { zoomPct = 100; }

      try {
        const savedMode = localStorage.getItem("sv_follow_mode") || "none";
        followMode = (savedMode === "width" || savedMode === "page") ? savedMode : "none";
      } catch (_) { followMode = "none"; }

      applyZoom();
      setActiveModeButtons();

      zoomEl.addEventListener("input", () => { disableFollowMode(); setZoomPercent(parseInt(zoomEl.value, 10)); });
      zoomOutBtn.addEventListener("click", () => { disableFollowMode(); setZoomPercent(zoomPct - 10); });
      zoomInBtn.addEventListener("click", () => { disableFollowMode(); setZoomPercent(zoomPct + 10); });
      zoomResetBtn.addEventListener("click", () => { disableFollowMode(); setZoomPercent(100); });

      function computeFitToWidthPct() {
        const containerWidth = pinchArea.getBoundingClientRect().width;
        const baseWidth = pagesEl.getBoundingClientRect().width;
        if (!containerWidth || !baseWidth) return null;
        const margin = 24;
        const target = Math.floor(((containerWidth - margin) / baseWidth) * 100);
        return clamp(target, 50, 200);
      }
      function fitToWidthOnce() {
        const target = computeFitToWidthPct();
        if (target != null) setZoomPercent(target);
      }
      zoomFitBtn.addEventListener("click", () => { disableFollowMode(); fitToWidthOnce(); });

      function computeFitToPagePct() {
        const firstImg = pagesEl.querySelector("img");
        if (!firstImg) return null;

        const bar = document.getElementById("bar");
        const barH = bar ? bar.getBoundingClientRect().height : 0;

        const availableH = window.innerHeight - barH - 24;
        if (availableH <= 0) return null;

        const rect = firstImg.getBoundingClientRect();
        const currentZoom = zoomPct / 100;
        const baseH = rect.height / currentZoom;
        if (!baseH) return null;

        const target = Math.floor((availableH / baseH) * 100);
        return clamp(target, 50, 200);
      }
      function fitToPageOnce() {
        const target = computeFitToPagePct();
        if (target != null) setZoomPercent(target);
      }

      modeWidthBtn.addEventListener("click", () => {
        if (followMode === "width") setFollowMode("none");
        else { setFollowMode("width"); fitToWidthOnce(); }
      });
      modePageBtn.addEventListener("click", () => {
        if (followMode === "page") setFollowMode("none");
        else { setFollowMode("page"); fitToPageOnce(); }
      });

      function onResizeFollow() {
        if (followMode === "width") fitToWidthOnce();
        if (followMode === "page") fitToPageOnce();
      }
      window.addEventListener("resize", onResizeFollow);

      // Pinch-to-zoom disables follow mode
      let pinchActive = false;
      let startDist = 0;
      let startZoom = 100;

      function dist(t1, t2) {
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }

      pinchArea.addEventListener("touchstart", (e) => {
        if (e.touches && e.touches.length === 2) {
          pinchActive = true;
          startDist = dist(e.touches[0], e.touches[1]);
          startZoom = zoomPct;
          disableFollowMode();
        }
      }, { passive: true });

      pinchArea.addEventListener("touchmove", (e) => {
        if (!pinchActive) return;
        if (!e.touches || e.touches.length !== 2) return;

        const d = dist(e.touches[0], e.touches[1]);
        if (!startDist) return;

        const ratio = d / startDist;
        const next = Math.round(startZoom * ratio);

        zoomPct = clamp(next, 50, 200);
        applyZoom();
      }, { passive: true });

      pinchArea.addEventListener("touchend", (e) => {
        if (!e.touches || e.touches.length < 2) {
          pinchActive = false;
          startDist = 0;
        }
      });

      // --- Focus mode
      function setFocusMode(on) {
        document.body.classList.toggle("focus", !!on);
        btnFocus.classList.toggle("active", !!on);
        btnFocus.textContent = on ? "Stop focus" : "Focus";
      }

      btnFocus.addEventListener("click", () => {
        const on = !document.body.classList.contains("focus");
        setFocusMode(on);
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (document.body.classList.contains("focus")) setFocusMode(false);
          if (bmPanel.style.display === "block") bmPanel.style.display = "none";
          if (idlePrompt.style.display === "flex") idlePrompt.style.display = "none";
        }
      });

      // --- Bookmarks panel
      btnBookmarks.addEventListener("click", () => {
        bmPanel.style.display = (bmPanel.style.display === "block") ? "none" : "block";
        renderBookmarksPanel();
      });
      bmClose.addEventListener("click", () => { bmPanel.style.display = "none"; });

      // --- Page indicator + scroll progress
      function updatePageIndicator(pageNum) {
        if (!pageList.length || !pageIndexByNumber.size) return;
        const idx = pageIndexByNumber.get(pageNum);
        if (idx == null) return;

        // NEW: show both (range index + original page number)
        pageIndicator.textContent = `Pagina ${idx + 1} / ${pageList.length} (Origineel: ${pageNum})`;
      }

      function updateProgressBar() {
        const docEl = document.documentElement;
        const scrollTop = docEl.scrollTop || document.body.scrollTop;
        const scrollHeight = docEl.scrollHeight || document.body.scrollHeight;
        const clientHeight = docEl.clientHeight || window.innerHeight;
        const maxScroll = Math.max(1, scrollHeight - clientHeight);
        const pct = Math.max(0, Math.min(1, scrollTop / maxScroll));
        progressBar.style.width = `${Math.round(pct * 100)}%`;
      }

      window.addEventListener("scroll", () => { updateProgressBar(); }, { passive: true });

      // Observe which page card is in view
      let io = null;
      function setupIntersectionObserver() {
        if (io) io.disconnect();
        io = new IntersectionObserver((entries) => {
          let best = null;
          for (const e of entries) {
            if (!e.isIntersecting) continue;
            if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
          }
          if (!best) return;

          const pageNum = parseInt(best.target.getAttribute("data-page"), 10);
          if (!Number.isFinite(pageNum)) return;

          if (currentVisiblePage !== pageNum) {
            currentVisiblePage = pageNum;
            updatePageIndicator(pageNum);
            updatePrevNextButtons();
          }
        }, { threshold: [0.25, 0.5, 0.75] });
      }

      // NEW: prev/next
      function currentIndex() {
        if (!currentVisiblePage) return 0;
        const idx = pageIndexByNumber.get(currentVisiblePage);
        return (idx == null) ? 0 : idx;
      }

      function updatePrevNextButtons() {
        const idx = currentIndex();
        btnPrev.disabled = (idx <= 0);
        btnNext.disabled = (idx >= pageList.length - 1);
        btnPrev.style.opacity = btnPrev.disabled ? "0.4" : "1";
        btnNext.style.opacity = btnNext.disabled ? "0.4" : "1";
      }

      btnPrev.addEventListener("click", () => {
        const idx = currentIndex();
        const targetIdx = Math.max(0, idx - 1);
        scrollToPage(pageList[targetIdx]);
      });
      btnNext.addEventListener("click", () => {
        const idx = currentIndex();
        const targetIdx = Math.min(pageList.length - 1, idx + 1);
        scrollToPage(pageList[targetIdx]);
      });

      // NEW: study time tracker (active time)
      // - telt alleen als tab zichtbaar is √©n er recent activiteit is (laatste 45s)
      let studySeconds = 0;
      let lastActivityAt = Date.now();
      const ACTIVE_WINDOW_MS = 45 * 1000;

      function markActivity() {
        lastActivityAt = Date.now();
        hideIdlePrompt();
      }

      ["scroll", "mousemove", "keydown", "touchstart", "touchmove", "click"].forEach((evt) => {
        window.addEventListener(evt, markActivity, { passive: true });
      });

      function updateStudyTimeUI() {
        studyTimeEl.textContent = `Tijd: ${formatMMSS(studySeconds)}`;
      }

      setInterval(() => {
        const visible = document.visibilityState === "visible";
        const activeRecently = (Date.now() - lastActivityAt) <= ACTIVE_WINDOW_MS;
        if (visible && activeRecently) {
          studySeconds += 1;
          updateStudyTimeUI();
        }
      }, 1000);

      // NEW: inactivity soft prompt
      const IDLE_AFTER_MS = 3 * 60 * 1000; // 3 min
      let idleTimer = null;

      function hideIdlePrompt() { idlePrompt.style.display = "none"; }
      function showIdlePrompt() {
        if (document.body.classList.contains("focus")) return; // focus = no nagging
        idlePrompt.style.display = "flex";
      }

      function resetIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);
        idleTimer = setTimeout(showIdlePrompt, IDLE_AFTER_MS);
      }

      function initIdle() {
        resetIdleTimer();
        ["scroll","mousemove","keydown","touchstart","touchmove","click"].forEach((evt) => {
          window.addEventListener(evt, resetIdleTimer, { passive: true });
        });
      }

      idleYes.addEventListener("click", () => { markActivity(); resetIdleTimer(); });
      idleHide.addEventListener("click", () => { hideIdlePrompt(); resetIdleTimer(); });

      // Main
      (async function () {
        try {
          // doc from URL
          const parts = window.location.pathname.split("/");
          docId = parts[parts.length - 1];

          const params = new URLSearchParams(window.location.search);
          const t = params.get("t") || "";

          // Identity (watermark)
          const meUrl = `/api/me${t ? `?t=${encodeURIComponent(t)}` : ""}`;
          let me = { userId: "", name: "" };
          try {
            const meRes = await fetch(meUrl, { credentials: "include" });
            if (meRes.ok) me = await meRes.json();
          } catch (_) {}
          makeTiledWatermark(`Naam: ${me.name || "?"}\nID: ${me.userId || "?"}`);

          // Manifest
          const manifestUrl =
            `/api/docs/${encodeURIComponent(docId)}/manifest` +
            (t ? `?t=${encodeURIComponent(t)}` : "");

          const manifestRes = await fetch(manifestUrl, { credentials: "include" });
          if (!manifestRes.ok) {
            msg.textContent = `Kan document niet laden (${manifestRes.status}).`;
            return;
          }

          const manifest = await manifestRes.json();
          pageList = Array.isArray(manifest.pageList) ? manifest.pageList : [];
          if (!pageList.length) {
            msg.textContent = "Documentfout.";
            return;
          }

          pageIndexByNumber = new Map();
          pageList.forEach((n, i) => pageIndexByNumber.set(n, i));

          setupIntersectionObserver();

          for (const pageNum of pageList) {
            const card = document.createElement("div");
            card.className = "pageCard";
            card.setAttribute("data-page", String(pageNum));

            const tools = document.createElement("div");
            tools.className = "pageTools";

            const bmBtn = document.createElement("button");
            bmBtn.className = "toolBtn";
            bmBtn.type = "button";
            bmBtn.title = "Bladwijzer";
            bmBtn.textContent = "üîñ";
            bmBtn.setAttribute("data-action", "bookmark");
            bmBtn.classList.toggle("on", isMarked("bookmark", pageNum));
            bmBtn.addEventListener("click", () => toggleMark("bookmark", pageNum));

            const impBtn = document.createElement("button");
            impBtn.className = "toolBtn";
            impBtn.type = "button";
            impBtn.title = "Markeer als belangrijk";
            impBtn.textContent = "‚≠ê";
            impBtn.setAttribute("data-action", "important");
            impBtn.classList.toggle("on", isMarked("important", pageNum));
            impBtn.addEventListener("click", () => toggleMark("important", pageNum));

            tools.appendChild(bmBtn);
            tools.appendChild(impBtn);

            const img = document.createElement("img");
            img.loading = "lazy";
            img.alt = `Pagina ${pageNum}`;
            img.src =
              `/api/docs/${encodeURIComponent(docId)}/page/${pageNum}` +
              (t ? `?t=${encodeURIComponent(t)}` : "");

            card.appendChild(tools);
            card.appendChild(img);
            pagesEl.appendChild(card);

            io.observe(card);
          }

          // Initial UI updates
          updateProgressBar();
          currentVisiblePage = pageList[0];
          updatePageIndicator(pageList[0]);
          updatePrevNextButtons();
          updateStudyTimeUI();
          initIdle();

          // If follow mode is active, adjust after first image loads
          const firstImg = pagesEl.querySelector("img");
          if (firstImg) {
            firstImg.addEventListener("load", () => {
              if (followMode === "page") {
                const target = computeFitToPagePct();
                if (target != null) setZoomPercent(target);
              }
              if (followMode === "width") {
                const target = computeFitToWidthPct();
                if (target != null) setZoomPercent(target);
              }
            }, { once: true });
          }

          renderBookmarksPanel();

        } catch (e) {
          msg.textContent = "Er ging iets mis.";
        }
      })();
    </script>
  </body>
</html>

