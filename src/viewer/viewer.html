<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Secure Viewer</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; }

      #pages { padding: 16px; display: grid; gap: 16px; }
      img { width: 100%; height: auto; border: 1px solid #eee; }

      /* Geen tekstselectie / slepen */
      body { -webkit-user-select: none; user-select: none; }
      img { -webkit-user-drag: none; user-drag: none; }

      /* Watermark overlay: boven alles, niet klikbaar, licht */
      #wm {
        position: fixed;
        inset: 0;
        z-index: 9999;
        pointer-events: none;
        opacity: 0.05;
        transform: rotate(-18deg);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: 180px;
        align-items: center;
        justify-items: center;
        text-align: center;
        font-size: 20px;
        line-height: 1.35;
        padding: 24px;
        gap: 10px;
      }
      .wm-cell { white-space: pre-wrap; padding: 8px 12px; }

      /* Eventuele foutmelding (onzichtbaar tot nodig) */
      #msg { padding: 12px 16px; color: #b00020; font-size: 14px; }
    </style>
  </head>

  <body>
    <div id="wm"></div>
    <div id="msg"></div>
    <div id="pages"></div>

    <script>
      // Rechtermuisklik blokkeren
      document.addEventListener("contextmenu", (e) => e.preventDefault());

      // Ctrl/Cmd+S en Ctrl/Cmd+P blokkeren
      document.addEventListener("keydown", (e) => {
        const key = (e.key || "").toLowerCase();
        if ((e.ctrlKey || e.metaKey) && (key === "s" || key === "p")) e.preventDefault();
      });

      function makeTiledWatermark(text) {
        const wmEl = document.getElementById("wm");
        wmEl.innerHTML = "";
        const cells = 18;
        for (let i = 0; i < cells; i++) {
          const cell = document.createElement("div");
          cell.className = "wm-cell";
          cell.textContent = text;
          wmEl.appendChild(cell);
        }
      }

      (async function () {
        try {
          // doc zit in de URL, maar we tonen hem nergens
          const parts = window.location.pathname.split("/");
          const doc = parts[parts.length - 1];

          const params = new URLSearchParams(window.location.search);
          const t = params.get("t") || "";

          const msg = document.getElementById("msg");
          const pagesEl = document.getElementById("pages");

          // Identiteit ophalen (alleen name + userId)
          const meUrl = `/api/me${t ? `?t=${encodeURIComponent(t)}` : ""}`;
          let me = { userId: "", name: "" };
          try {
            const meRes = await fetch(meUrl, { credentials: "include" });
            if (meRes.ok) me = await meRes.json();
          } catch (_) {}

          // Watermark: enkel Naam + ID
          makeTiledWatermark(`Naam: ${me.name || "?"}\nID: ${me.userId || "?"}`);

          // Manifest ophalen
          const manifestUrl =
            `/api/docs/${encodeURIComponent(doc)}/manifest` +
            (t ? `?t=${encodeURIComponent(t)}` : "");

          const manifestRes = await fetch(manifestUrl, { credentials: "include" });
          if (!manifestRes.ok) {
            msg.textContent = `Kan document niet laden (${manifestRes.status}).`;
            return;
          }

          const manifest = await manifestRes.json();
          if (!manifest.pages) {
            msg.textContent = "Documentfout.";
            return;
          }

          // Pagina's laden
          for (let i = 1; i <= manifest.pages; i++) {
            const img = document.createElement("img");
            img.loading = "lazy";
            img.alt = `Pagina ${i}`;
            img.src =
              `/api/docs/${encodeURIComponent(doc)}/page/${i}` +
              (t ? `?t=${encodeURIComponent(t)}` : "");
            pagesEl.appendChild(img);
          }
        } catch (e) {
          document.getElementById("msg").textContent = "Er ging iets mis.";
        }
      })();
    </script>
  </body>
</html>
